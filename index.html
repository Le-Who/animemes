<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ВАЖНО: Разрешает загрузку картинок с других сайтов -->
    <meta name="referrer" content="no-referrer">
    <title>Anime PostGuess</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --win: #22c55e; --lose: #ef4444; --nsfw: #f43f5e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body {
            font-family: 'Outfit', sans-serif; background: var(--bg);
            color: var(--text); height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .header {
            padding: 15px 30px; display: flex; justify-content: space-between;
            align-items: center; z-index: 10; background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        .logo { font-weight: 900; font-size: 1.4rem; letter-spacing: -1px; }
        
        /* SWITCH */
        .switch-wrap { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .switch-bg {
            width: 44px; height: 24px; background: #475569;
            border-radius: 20px; position: relative; transition: 0.3s;
        }
        .switch-dot {
            width: 18px; height: 18px; background: #fff;
            border-radius: 50%; position: absolute; top: 3px; left: 3px;
            transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        input:checked + .switch-bg { background: var(--nsfw); }
        input:checked + .switch-bg .switch-dot { transform: translateX(20px); }
        .switch-label { font-size: 0.9rem; font-weight: 700; }
        input { display: none; }

        /* SCORES */
        .scores { display: flex; gap: 20px; font-weight: 700; font-size: 1rem; }
        .score-box { display: flex; flex-direction: column; align-items: flex-end; }
        .score-val { font-size: 1.2rem; line-height: 1; }
        .score-label { font-size: 0.7rem; opacity: 0.6; text-transform: uppercase; }
        .best-val { color: #fbbf24; }

        /* GAME AREA */
        .game-area { flex: 1; display: flex; position: relative; }

        .card {
            flex: 1; position: relative; cursor: pointer;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; overflow: hidden;
            transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .card-bg {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0.4; transition: 0.5s; z-index: 0;
        }
        .card:hover .card-bg { transform: scale(1.05); opacity: 0.6; }
        
        .info { z-index: 2; position: relative; text-shadow: 0 4px 30px rgba(0,0,0,0.9); pointer-events: none; }
        .name { font-size: 2.5rem; font-weight: 900; line-height: 1.1; }
        .fran { font-size: 1rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 2px; margin-top: 5px;}
        .count { font-size: 4rem; font-weight: 800; margin-top: 20px; }
        
        .card.win { background: var(--win); }
        .card.lose { background: var(--lose); }
        .card.win .card-bg, .card.lose .card-bg { opacity: 0.15; }

        /* VS CIRCLE */
        .vs {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            background: #fff; color: #000;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; z-index: 20;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* BUTTON */
        .btn {
            position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #fff; color: #000;
            padding: 15px 40px; border-radius: 40px;
            font-weight: 800; border: none; cursor: pointer;
            opacity: 0; transition: 0.4s; z-index: 30;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .btn.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        @media(max-width: 768px) { .game-area { flex-direction: column; } .name { font-size: 1.8rem; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">PostGuess</div>
        
        <label class="switch-wrap">
            <input type="checkbox" id="modeSwitch">
            <div class="switch-bg"><div class="switch-dot"></div></div>
            <span class="switch-label">NSFW (18+)</span>
        </label>
        
        <div class="scores">
            <div class="score-box">
                <span class="score-val" id="score">0</span>
                <span class="score-label">Текущий</span>
            </div>
            <div class="score-box">
                <span class="score-val best-val" id="best">0</span>
                <span class="score-label">Лучший</span>
            </div>
        </div>
    </div>

    <div class="game-area">
        <!-- Карточка 1 (Левая) -->
        <div class="card" id="c1" onclick="vote('left')">
            <img src="" class="card-bg" id="img1">
            <div class="info">
                <div class="name" id="name1"></div>
                <div class="fran" id="fran1"></div>
                <div class="count" id="count1">0</div>
            </div>
        </div>

        <div class="vs">VS</div>

        <!-- Карточка 2 (Правая) -->
        <div class="card" id="c2" onclick="vote('right')">
            <img src="" class="card-bg" id="img2">
            <div class="info">
                <div class="name" id="name2"></div>
                <div class="fran" id="fran2"></div>
                <div class="count" id="count2">?</div>
            </div>
        </div>
    </div>

    <button class="btn" id="nextBtn" onclick="next()">Дальше</button>

    <script>
        let db = [], pool = [];
        let leftItem, rightItem;
        let isNSFW = false;
        let locked = false;
        let score = 0;
        let bestScore = localStorage.getItem('pg_best') || 0;

        // Элементы
        const els = {
            c1: document.getElementById('c1'), c2: document.getElementById('c2'),
            img1: document.getElementById('img1'), img2: document.getElementById('img2'),
            name1: document.getElementById('name1'), name2: document.getElementById('name2'),
            fran1: document.getElementById('fran1'), fran2: document.getElementById('fran2'),
            cnt1: document.getElementById('count1'), cnt2: document.getElementById('count2'),
            score: document.getElementById('score'), best: document.getElementById('best'),
            btn: document.getElementById('nextBtn')
        };

        // Старт
        els.best.innerText = bestScore;
        
        // Загружаем JSON (добавлен timestamp для обхода кэша)
        fetch('characters.json?t='+Date.now()).then(r=>r.json()).then(data => {
            db = data;
            resetPool();
            startFirstRound();
        });

        // Переключение режима
        document.getElementById('modeSwitch').addEventListener('change', (e) => {
            isNSFW = e.target.checked;
            score = 0; updateScoreUI();
            
            // Полный сброс раунда при смене режима (чтобы обновились картинки)
            resetPool();
            startFirstRound();
        });

        function resetPool() {
            pool = [...db].sort(() => Math.random() - 0.5);
        }

        function getNext() {
            if (pool.length === 0) resetPool();
            return pool.pop();
        }

        function startFirstRound() {
            leftItem = getNext();
            rightItem = getNext();
            updateUI(false);
            
            // Сброс стилей
            locked = false;
            els.c1.className = 'card';
            els.c2.className = 'card';
            els.btn.classList.remove('show');
        }

        function next() {
            // Двигаем победителя влево (точнее, правую карточку влево)
            leftItem = rightItem;
            rightItem = getNext();
            
            updateUI(false);
            
            // Сброс
            els.btn.classList.remove('show');
            locked = false;
            els.c1.className = 'card';
            els.c2.className = 'card';
        }

        function getVal(item) {
            return isNSFW ? item.counts.nsfw : item.counts.total;
        }

        function getImg(item) {
            // Если режим 18+ и есть NSFW картинка - показываем её
            if (isNSFW && item.images.nsfw) return item.images.nsfw;
            // Иначе показываем SFW (или что есть)
            return item.images.sfw || item.images.nsfw;
        }

        function updateUI(revealed) {
            // Левая
            els.name1.innerText = leftItem.name;
            els.fran1.innerText = leftItem.franchise;
            els.cnt1.innerText = getVal(leftItem).toLocaleString();
            els.img1.src = getImg(leftItem);

            // Правая
            els.name2.innerText = rightItem.name;
            els.fran2.innerText = rightItem.franchise;
            els.img2.src = getImg(rightItem);
            
            if (revealed) {
                animateValue(els.cnt2, 0, getVal(rightItem), 600);
            } else {
                els.cnt2.innerText = "?";
            }
        }

        function vote(side) {
            if (locked) return;
            locked = true;

            const v1 = getVal(leftItem);
            const v2 = getVal(rightItem);
            const isWin = (side === 'left' && v1 >= v2) || (side === 'right' && v2 >= v1);

            updateUI(true); // Показать число

            if (isWin) {
                score++;
                if (score > bestScore) {
                    bestScore = score;
                    localStorage.setItem('pg_best', bestScore);
                }
                if (side === 'left') els.c1.classList.add('win');
                else els.c2.classList.add('win');
            } else {
                score = 0;
                if (side === 'left') { els.c1.classList.add('lose'); els.c2.classList.add('win'); }
                else { els.c2.classList.add('lose'); els.c1.classList.add('win'); }
            }
            
            updateScoreUI();
            els.btn.classList.add('show');
        }

        function updateScoreUI() {
            els.score.innerText = score;
            els.best.innerText = bestScore;
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>
