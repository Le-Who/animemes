<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ВАЖНО: Разрешает загрузку картинок с других сайтов -->
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' https://*.gelbooru.com; connect-src 'self'; base-uri 'self'; form-action 'self';">
    <title>Кто хочет стать Дуней</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://img2.gelbooru.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --win: #22c55e; --lose: #ef4444; --nsfw: #f43f5e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body {
            font-family: 'Outfit', sans-serif; background: var(--bg);
            color: var(--text); height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .header {
            padding: 15px 30px; display: flex; justify-content: space-between;
            align-items: center; z-index: 10; background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        .logo { font-weight: 900; font-size: 1.4rem; letter-spacing: -1px; }
        
        /* SWITCH */
        .switch-wrap { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .switch-bg {
            width: 44px; height: 24px; background: #475569;
            border-radius: 20px; position: relative; transition: 0.3s;
        }
        .switch-dot {
            width: 18px; height: 18px; background: #fff;
            border-radius: 50%; position: absolute; top: 3px; left: 3px;
            transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        input:checked + .switch-bg { background: var(--nsfw); }
        input:checked + .switch-bg .switch-dot { transform: translateX(20px); }
        .switch-label { font-size: 0.9rem; font-weight: 700; }

        .switch-wrap input {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
            opacity: 0;
        }

        /* SCORES */
        .scores { display: flex; gap: 20px; font-weight: 700; font-size: 1rem; }
        .score-box { display: flex; flex-direction: column; align-items: flex-end; }
        .score-val { font-size: 1.2rem; line-height: 1; }
        .score-label { font-size: 0.7rem; opacity: 0.6; text-transform: uppercase; }
        .best-val { color: #fbbf24; }

        /* GAME AREA */
        .game-area { flex: 1; display: flex; position: relative; }

        .card {
            flex: 1; 
            position: relative; 
            cursor: pointer;
            display: flex; 
            flex-direction: column;
            justify-content: center; /* Центрируем контент (текст) */
            align-items: center;
            text-align: center; 
            overflow: hidden;
            transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1);
            background: #000; /* Черный фон под картинкой */
        }
        
        /* Размытый фон для заполнения пустот */
        .card::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            filter: blur(30px) brightness(0.4);
            z-index: 0;
            transition: background-image 0.5s ease;
        }

        .card-bg {
            position: absolute; 
            inset: 0; 
            width: 100%; 
            height: 100%;
            /* Картинка видна полностью */
            object-fit: contain; 
            opacity: 1; 
            transition: 0.5s; 
            z-index: 1;
        }
        
        .card:hover .card-bg { 
            transform: scale(1.02); 
        }
        
        .info { 
            z-index: 2; 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%;
            padding: 40px 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            text-shadow: 0 2px 10px rgba(0,0,0,0.8); 
            pointer-events: none; 
        }
        
        .name { font-size: 2.5rem; font-weight: 900; line-height: 1.1; margin-bottom: 5px; }
        .fran { font-size: 1rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 2px; color: #cbd5e1; }
        .count { font-size: 4rem; font-weight: 800; margin-top: 15px; color: #fff; }
        
        /* Результаты */
        .card.win::after {
            content: ''; position: absolute; inset: 0; background: var(--win); opacity: 0.3; z-index: 3;
        }
        .card.lose::after {
            content: ''; position: absolute; inset: 0; background: var(--lose); opacity: 0.3; z-index: 3;
        }

        /* Status Icons */
        .status-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            width: 80px; height: 80px; z-index: 4; opacity: 0; transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); pointer-events: none;
        }
        .status-icon svg { width: 48px; height: 48px; stroke-width: 3; }
        .card.win .status-icon-win { opacity: 1; transform: translate(-50%, -50%) scale(1); color: var(--win); }
        .card.lose .status-icon-lose { opacity: 1; transform: translate(-50%, -50%) scale(1); color: var(--lose); }

        /* VS CIRCLE */
        .vs {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            background: #fff; color: #000;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; z-index: 20;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* BUTTON */
        .btn {
            position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #fff; color: #000;
            padding: 15px 40px; border-radius: 40px;
            font-weight: 800; border: none; cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s, transform 0.4s, visibility 0.4s;
            z-index: 30;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .btn.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            transition: opacity 0.4s, transform 0.4s, visibility 0s;
        }

        /* Status Icons */
        .status-icon {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            font-size: 8rem; font-weight: 900;
            opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 4; text-shadow: 0 5px 20px rgba(0,0,0,0.5);
            pointer-events: none;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .card.win .status-icon { opacity: 1; transform: translate(-50%, -50%) scale(1); color: #4ade80; }
        .card.lose .status-icon { opacity: 1; transform: translate(-50%, -50%) scale(1); color: #f87171; }
        .card.win .status-icon::before { content: '✓'; }
        .card.lose .status-icon::before { content: '✕'; }

        /* Accessibility Focus Styles */
        .card:focus-visible {
            outline: 4px solid #fff;
            outline-offset: -4px;
            z-index: 10;
        }
        .switch-wrap input:focus-visible + .switch-bg {
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        /* Keyboard Hints */
        .key-hint {
            position: absolute;
            top: 20px;
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.6);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.2rem;
            backdrop-filter: blur(4px);
            z-index: 5;
            pointer-events: none;
            opacity: 0.8;
            font-family: monospace;
        }
        #c1 .key-hint { left: 20px; }
        #c2 .key-hint { right: 20px; }

        .btn .key-hint {
            position: static;
            display: inline-block;
            width: auto; height: auto;
            background: transparent;
            border: 1px solid currentColor;
            border-radius: 4px;
            padding: 0 6px;
            margin-left: 8px;
            font-size: 0.9em;
            vertical-align: 1px;
            backdrop-filter: none;
        }

        @media(max-width: 768px) { 
            .game-area { flex-direction: column; } 
            .name { font-size: 1.8rem; } 
            .info { position: relative; background: none; padding: 20px; }
            .card { justify-content: flex-end; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">Звенящая пошлость</div>
        
        <label class="switch-wrap">
            <input type="checkbox" id="modeSwitch" class="visually-hidden">
            <div class="switch-bg"><div class="switch-dot"></div></div>
            <span class="switch-label">NSFW (18+)</span>
        </label>
        
        <div class="scores">
            <div class="score-box">
                <span class="score-val" id="score">0</span>
                <span class="score-label">Current</span>
            </div>
            <div class="score-box">
                <span class="score-val best-val" id="best">0</span>
                <span class="score-label">Best</span>
            </div>
        </div>
    </div>

    <div class="game-area">
        <!-- Карточка 1 (Левая) -->
        <div class="card" id="c1" onclick="vote('left')" role="button" tabindex="0" onkeydown="handleCardKey(event, 'left')">
            <div class="status-icon" aria-hidden="true"></div>
            <div class="key-hint">←</div>
            <div class="status-icon status-icon-win" aria-hidden="true">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
            </div>
            <div class="status-icon status-icon-lose" aria-hidden="true">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </div>
            <img src="" class="card-bg" id="img1">
            <div class="info">
                <div class="name" id="name1">Loading...</div>
                <div class="fran" id="fran1"></div>
                <div class="count" id="count1">0</div>
            </div>
        </div>

        <div class="vs">VS</div>

        <!-- Карточка 2 (Правая) -->
        <div class="card" id="c2" onclick="vote('right')" role="button" tabindex="0" onkeydown="handleCardKey(event, 'right')">
            <div class="status-icon" aria-hidden="true"></div>
            <div class="key-hint">→</div>
            <div class="status-icon status-icon-win" aria-hidden="true">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
            </div>
            <div class="status-icon status-icon-lose" aria-hidden="true">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </div>
            <img src="" class="card-bg" id="img2">
            <div class="info">
                <div class="name" id="name2">Loading...</div>
                <div class="fran" id="fran2"></div>
                <div class="count" id="count2">?</div>
            </div>
        </div>
    </div>

    <button class="btn" id="nextBtn" onclick="next()">Дальше <span class="key-hint">↵</span></button>

    <script>
        // Security Sanitization

        /**
         * Strict URL sanitizer for HTML attributes (src, etc).
         * Enforces https/http whitelist and percent-encodes quotes.
         */
        function safeUrl(url) {
            if (typeof url !== 'string') return '';
            if (!url.startsWith('https://') && !url.startsWith('http://')) return '';
            // encodeURI handles spaces and double quotes (%22).
            // Manually escape single quotes (%27) for attribute safety.
            return encodeURI(url).replace(/'/g, '%27');
        }

        /**
         * Strict URL sanitizer for CSS values (url(...)).
         * Prevents injection via quotes or parentheses.
         */
        function safeCSSUrl(url) {
            if (typeof url !== 'string') return '';
            if (!url.startsWith('https://') && !url.startsWith('http://')) return '';
            // For CSS url(), we must escape single quotes and parentheses
            return encodeURI(url)
                .replace(/'/g, '%27')
                .replace(/\(/g, '%28')
                .replace(/\)/g, '%29');
        }

        let db = [], pool = [];
        let leftItem, rightItem;
        let isNSFW = false;
        let locked = false;
        let score = 0;
        let bestScore = localStorage.getItem('pg_best') || 0;
        
        // Новая переменная для хранения ID анимации
        let currentAnimId = null;

        // Элементы
        const els = {
            c1: document.getElementById('c1'), c2: document.getElementById('c2'),
            img1: document.getElementById('img1'), img2: document.getElementById('img2'),
            name1: document.getElementById('name1'), name2: document.getElementById('name2'),
            fran1: document.getElementById('fran1'), fran2: document.getElementById('fran2'),
            cnt1: document.getElementById('count1'), cnt2: document.getElementById('count2'),
            score: document.getElementById('score'), best: document.getElementById('best'),
            btn: document.getElementById('nextBtn')
        };

        // Старт
        els.best.textContent = bestScore;
        
        // OPTIMIZATION: Removed timestamp query param to enable browser caching
        fetch('characters.json')
            .then(r => r.json())
            .then(data => {
                db = data;
                if(db.length < 2) {
                    alert("В базе мало персонажей! Запустите manage.py.");
                    return;
                }
                resetPool();
                startFirstRound();
            })
            .catch(e => console.error("Ошибка загрузки:", e));

        // Переключение режима
        document.getElementById('modeSwitch').addEventListener('change', (e) => {
            isNSFW = e.target.checked;
            score = 0; updateScoreUI();
            resetPool();
            startFirstRound();
        });

        /**
         * Fisher-Yates Shuffle for O(n) unbiased shuffling.
         * Replaces O(n log n) sort-based shuffle.
         */
        function shuffle(array) {
            let m = array.length, t, i;
            while (m) {
                i = Math.floor(Math.random() * m--);
                t = array[m];
                array[m] = array[i];
                array[i] = t;
            }
            return array;
        }

        function resetPool() {
            pool = shuffle([...db]);
        }

        function getNext() {
            if (pool.length === 0) resetPool();
            return pool.pop();
        }

        // Функция для остановки текущей анимации
        function stopAnimation() {
            if (currentAnimId) {
                cancelAnimationFrame(currentAnimId);
                currentAnimId = null;
            }
        }

        function startFirstRound() {
            stopAnimation(); // Останавливаем старую анимацию перед стартом
            leftItem = getNext();
            rightItem = getNext();
            updateUI(false);
            
            // Сброс стилей
            locked = false;
            els.c1.classList.remove('win', 'lose');
            els.c2.classList.remove('win', 'lose');
            els.btn.classList.remove('show');

            preloadNext();
        }

        function next() {
            stopAnimation(); // КРИТИЧНО ВАЖНО: Останавливаем анимацию здесь
            
            // Двигаем победителя влево
            leftItem = rightItem;
            rightItem = getNext();
            
            updateUI(false); // Здесь поставится "?"
            
            // Сброс
            els.btn.classList.remove('show');
            locked = false;
            els.c1.classList.remove('win', 'lose');
            els.c2.classList.remove('win', 'lose');

            preloadNext();
        }

        function getVal(item) {
            return isNSFW ? item.counts.nsfw : item.counts.total;
        }

        function getImg(item) {
            let url;
            if (isNSFW && item.images.nsfw) url = item.images.nsfw;
            else url = item.images.sfw || item.images.nsfw;
            return url;
        }

        function updateUI(revealed) {
            // Левая
            // OPTIMIZATION: Use textContent instead of innerHTML/innerText to prevent layout thrashing
            els.name1.textContent = leftItem.name;
            els.fran1.textContent = leftItem.franchise;
            els.cnt1.textContent = getVal(leftItem).toLocaleString();
            
            const url1 = getImg(leftItem);
            els.img1.src = safeUrl(url1);
            els.img1.alt = `${leftItem.name} (${leftItem.franchise})`;
            els.c1.setAttribute('aria-label', `Vote for ${leftItem.name}`);
            els.c1.style.setProperty('--bg-image', `url('${safeCSSUrl(url1)}')`);

            // Правая
            els.name2.textContent = rightItem.name;
            els.fran2.textContent = rightItem.franchise;
            
            const url2 = getImg(rightItem);
            els.img2.src = safeUrl(url2);
            els.img2.alt = `${rightItem.name} (${rightItem.franchise})`;
            els.c2.setAttribute('aria-label', `Vote for ${rightItem.name}`);
            els.c2.style.setProperty('--bg-image', `url('${safeCSSUrl(url2)}')`);
            
            if (revealed) {
                animateValue(els.cnt2, 0, getVal(rightItem), 600);
            } else {
                els.cnt2.textContent = "?";
            }
        }

        function vote(side) {
            if (locked) return;
            locked = true;

            const v1 = getVal(leftItem);
            const v2 = getVal(rightItem);
            const isWin = (side === 'left' && v1 >= v2) || (side === 'right' && v2 >= v1);

            updateUI(true); // Запускает анимацию

            if (isWin) {
                score++;
                if (score > bestScore) {
                    bestScore = score;
                    localStorage.setItem('pg_best', bestScore);
                }
                if (side === 'left') els.c1.classList.add('win');
                else els.c2.classList.add('win');
            } else {
                score = 0;
                if (side === 'left') { els.c1.classList.add('lose'); els.c2.classList.add('win'); }
                else { els.c2.classList.add('lose'); els.c1.classList.add('win'); }
            }
            
            updateScoreUI();
            els.btn.classList.add('show');
        }

        function updateScoreUI() {
            els.score.textContent = score;
            els.best.textContent = bestScore;
        }

        function animateValue(obj, start, end, duration) {
            stopAnimation(); // На всякий случай сбрасываем перед запуском новой
            
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                // Bolt: Use textContent for better performance in animation loop
                obj.textContent = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) {
                    currentAnimId = window.requestAnimationFrame(step);
                } else {
                    currentAnimId = null;
                }
            };
            currentAnimId = window.requestAnimationFrame(step);
        }

        // Keyboard Support
        function handleCardKey(e, side) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                if (locked) next();
                else vote(side);
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' && !locked) vote('left');
            if (e.key === 'ArrowRight' && !locked) vote('right');
            if (e.key === 'Enter' && locked && document.activeElement === document.body) next();
        });
        function preloadNext() {
            // OPTIMIZATION: Preload upcoming 3 images to prevent lag between rounds
            const PRELOAD_COUNT = 3;

            // If the pool is empty, refill it now to identify the next image.
            // This shifts the shuffle timing slightly but preserves randomness.
            if (pool.length === 0) resetPool();

            if (pool.length > 0) {
                // Preload up to PRELOAD_COUNT images from the end of the pool
                for (let i = 1; i <= PRELOAD_COUNT; i++) {
                    const idx = pool.length - i;
                    if (idx >= 0) {
                        const nextItem = pool[idx];
                        const img = new Image();
                        img.src = safeUrl(getImg(nextItem));
                    } else {
                        break;
                    }
                }
            }
        }
    </script>
</body>
</html>
